<template>

    <div>

        <!-- Whatsapp Action Trigger -->
        <CustomDropdown
            ref="dropdown"
            triggerSize="xs"
            triggerType="light"
            triggerText="Whatsapp"
            :triggerLoading="isLoadingStore || isLoadingOrder">

            <template #content>

                <div class="flex space-x-2 items-center px-2 py-1 text-sm bg-green-100">

                    <svg class="w-8 h-8" xmlns="http://www.w3.org/2000/svg"  viewBox="0 0 48 48" width="96px" height="96px" fill-rule="evenodd" clip-rule="evenodd">
                        <path fill="#fff" d="M4.868,43.303l2.694-9.835C5.9,30.59,5.026,27.324,5.027,23.979C5.032,13.514,13.548,5,24.014,5c5.079,0.002,9.845,1.979,13.43,5.566c3.584,3.588,5.558,8.356,5.556,13.428c-0.004,10.465-8.522,18.98-18.986,18.98c-0.001,0,0,0,0,0h-0.008c-3.177-0.001-6.3-0.798-9.073-2.311L4.868,43.303z"/>
                        <path fill="#fff" d="M4.868,43.803c-0.132,0-0.26-0.052-0.355-0.148c-0.125-0.127-0.174-0.312-0.127-0.483l2.639-9.636c-1.636-2.906-2.499-6.206-2.497-9.556C4.532,13.238,13.273,4.5,24.014,4.5c5.21,0.002,10.105,2.031,13.784,5.713c3.679,3.683,5.704,8.577,5.702,13.781c-0.004,10.741-8.746,19.48-19.486,19.48c-3.189-0.001-6.344-0.788-9.144-2.277l-9.875,2.589C4.953,43.798,4.911,43.803,4.868,43.803z"/>
                        <path fill="#cfd8dc" d="M24.014,5c5.079,0.002,9.845,1.979,13.43,5.566c3.584,3.588,5.558,8.356,5.556,13.428c-0.004,10.465-8.522,18.98-18.986,18.98h-0.008c-3.177-0.001-6.3-0.798-9.073-2.311L4.868,43.303l2.694-9.835C5.9,30.59,5.026,27.324,5.027,23.979C5.032,13.514,13.548,5,24.014,5 M24.014,42.974C24.014,42.974,24.014,42.974,24.014,42.974C24.014,42.974,24.014,42.974,24.014,42.974 M24.014,42.974C24.014,42.974,24.014,42.974,24.014,42.974C24.014,42.974,24.014,42.974,24.014,42.974 M24.014,4C24.014,4,24.014,4,24.014,4C12.998,4,4.032,12.962,4.027,23.979c-0.001,3.367,0.849,6.685,2.461,9.622l-2.585,9.439c-0.094,0.345,0.002,0.713,0.254,0.967c0.19,0.192,0.447,0.297,0.711,0.297c0.085,0,0.17-0.011,0.254-0.033l9.687-2.54c2.828,1.468,5.998,2.243,9.197,2.244c11.024,0,19.99-8.963,19.995-19.98c0.002-5.339-2.075-10.359-5.848-14.135C34.378,6.083,29.357,4.002,24.014,4L24.014,4z"/>
                        <path fill="#40c351" d="M35.176,12.832c-2.98-2.982-6.941-4.625-11.157-4.626c-8.704,0-15.783,7.076-15.787,15.774c-0.001,2.981,0.833,5.883,2.413,8.396l0.376,0.597l-1.595,5.821l5.973-1.566l0.577,0.342c2.422,1.438,5.2,2.198,8.032,2.199h0.006c8.698,0,15.777-7.077,15.78-15.776C39.795,19.778,38.156,15.814,35.176,12.832z"/>
                        <path fill="#fff" fill-rule="evenodd" d="M19.268,16.045c-0.355-0.79-0.729-0.806-1.068-0.82c-0.277-0.012-0.593-0.011-0.909-0.011c-0.316,0-0.83,0.119-1.265,0.594c-0.435,0.475-1.661,1.622-1.661,3.956c0,2.334,1.7,4.59,1.937,4.906c0.237,0.316,3.282,5.259,8.104,7.161c4.007,1.58,4.823,1.266,5.693,1.187c0.87-0.079,2.807-1.147,3.202-2.255c0.395-1.108,0.395-2.057,0.277-2.255c-0.119-0.198-0.435-0.316-0.909-0.554s-2.807-1.385-3.242-1.543c-0.435-0.158-0.751-0.237-1.068,0.238c-0.316,0.474-1.225,1.543-1.502,1.859c-0.277,0.317-0.554,0.357-1.028,0.119c-0.474-0.238-2.002-0.738-3.815-2.354c-1.41-1.257-2.362-2.81-2.639-3.285c-0.277-0.474-0.03-0.731,0.208-0.968c0.213-0.213,0.474-0.554,0.712-0.831c0.237-0.277,0.316-0.475,0.474-0.791c0.158-0.317,0.079-0.594-0.04-0.831C20.612,19.329,19.69,16.983,19.268,16.045z" clip-rule="evenodd"/>
                    </svg>
                    <span class="text-xs">Send using Whatsapp</span>

                </div>

                <template
                    :key="index"
                    v-for="(whatsappAction, index) in whatsappActions">

                    <div
                        @click.stop="() => showSendToWhatsappModal(whatsappAction.label)"
                        class="cursor-pointer flex justify-between items-center py-2 px-4 text-gray-900 hover:bg-gray-100 group">

                        <div class="flex space-x-2 items-center">

                            <svg v-if="whatsappAction.label == 'Write message'" class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L6.832 19.82a4.5 4.5 0 0 1-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 0 1 1.13-1.897L16.863 4.487Zm0 0L19.5 7.125" />
                            </svg>

                            <svg v-if="whatsappAction.label == 'Request review'" class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M11.48 3.499a.562.562 0 0 1 1.04 0l2.125 5.111a.563.563 0 0 0 .475.345l5.518.442c.499.04.701.663.321.988l-4.204 3.602a.563.563 0 0 0-.182.557l1.285 5.385a.562.562 0 0 1-.84.61l-4.725-2.885a.562.562 0 0 0-.586 0L6.982 20.54a.562.562 0 0 1-.84-.61l1.285-5.386a.562.562 0 0 0-.182-.557l-4.204-3.602a.562.562 0 0 1 .321-.988l5.518-.442a.563.563 0 0 0 .475-.345L11.48 3.5Z" />
                            </svg>

                            <svg v-if="whatsappAction.label == 'Share order details'" class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M7.217 10.907a2.25 2.25 0 1 0 0 2.186m0-2.186c.18.324.283.696.283 1.093s-.103.77-.283 1.093m0-2.186 9.566-5.314m-9.566 7.5 9.566 5.314m0 0a2.25 2.25 0 1 0 3.935 2.186 2.25 2.25 0 0 0-3.935-2.186Zm0-12.814a2.25 2.25 0 1 0 3.933-2.185 2.25 2.25 0 0 0-3.933 2.185Z" />
                            </svg>

                            <svg v-if="whatsappAction.label == 'Remind about payment'" class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="m15 15-6 6m0 0-6-6m6 6V9a6 6 0 0 1 12 0v3" />
                            </svg>

                            <svg v-if="whatsappAction.label == 'Request proof of payment'" class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="m9 14.25 6-6m4.5-3.493V21.75l-3.75-1.5-3.75 1.5-3.75-1.5-3.75 1.5V4.757c0-1.108.806-2.057 1.907-2.185a48.507 48.507 0 0 1 11.186 0c1.1.128 1.907 1.077 1.907 2.185ZM9.75 9h.008v.008H9.75V9Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm4.125 4.5h.008v.008h-.008V13.5Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Z" />
                            </svg>

                            <svg v-if="whatsappAction.label == 'Send payment confirmation'" class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18.75a60.07 60.07 0 0 1 15.797 2.101c.727.198 1.453-.342 1.453-1.096V18.75M3.75 4.5v.75A.75.75 0 0 1 3 6h-.75m0 0v-.375c0-.621.504-1.125 1.125-1.125H20.25M2.25 6v9m18-10.5v.75c0 .414.336.75.75.75h.75m-1.5-1.5h.375c.621 0 1.125.504 1.125 1.125v9.75c0 .621-.504 1.125-1.125 1.125h-.375m1.5-1.5H21a.75.75 0 0 0-.75.75v.75m0 0H3.75m0 0h-.375a1.125 1.125 0 0 1-1.125-1.125V15m1.5 1.5v-.75A.75.75 0 0 0 3 15h-.75M15 10.5a3 3 0 1 1-6 0 3 3 0 0 1 6 0Zm3 0h.008v.008H18V10.5Zm-12 0h.008v.008H6V10.5Z" />
                            </svg>

                            <svg v-if="whatsappAction.label == 'Send completion confirmation'" class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                            </svg>

                            <svg v-if="whatsappAction.label == 'Send cancellation confirmation'" class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M10.05 4.575a1.575 1.575 0 1 0-3.15 0v3m3.15-3v-1.5a1.575 1.575 0 0 1 3.15 0v1.5m-3.15 0 .075 5.925m3.075.75V4.575m0 0a1.575 1.575 0 0 1 3.15 0V15M6.9 7.575a1.575 1.575 0 1 0-3.15 0v8.175a6.75 6.75 0 0 0 6.75 6.75h2.018a5.25 5.25 0 0 0 3.712-1.538l1.732-1.732a5.25 5.25 0 0 0 1.538-3.712l.003-2.024a.668.668 0 0 1 .198-.471 1.575 1.575 0 1 0-2.228-2.228 3.818 3.818 0 0 0-1.12 2.687M6.9 7.575V12m6.27 4.318A4.49 4.49 0 0 1 16.35 15m.002 0h-.002" />
                            </svg>

                            <svg v-if="whatsappAction.label == 'Send thank you message'" class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15.182 15.182a4.5 4.5 0 0 1-6.364 0M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0ZM9.75 9.75c0 .414-.168.75-.375.75S9 10.164 9 9.75 9.168 9 9.375 9s.375.336.375.75Zm-.375 0h.008v.015h-.008V9.75Zm5.625 0c0 .414-.168.75-.375.75s-.375-.336-.375-.75.168-.75.375-.75.375.336.375.75Zm-.375 0h.008v.015h-.008V9.75Z" />
                            </svg>

                            <svg v-if="whatsappAction.label == 'Suggest another option'" class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 18v-5.25m0 0a6.01 6.01 0 0 0 1.5-.189m-1.5.189a6.01 6.01 0 0 1-1.5-.189m3.75 7.478a12.06 12.06 0 0 1-4.5 0m3.75 2.383a14.406 14.406 0 0 1-3 0M14.25 18v-.192c0-.983.658-1.823 1.508-2.316a7.5 7.5 0 1 0-7.517 0c.85.493 1.509 1.333 1.509 2.316V18" />
                            </svg>

                            <span class="text-xs text-gray-500 group-hover:text-gray-900">
                                {{ whatsappAction.label }}
                            </span>

                        </div>

                        <svg v-if="whatsappAction.label == 'Suggest another option'" class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 4.5 21 12m0 0-7.5 7.5M21 12H3" />
                        </svg>

                    </div>

                </template>

                <!-- Suggest Another Option -->
                <a
                    href="#"
                    target="_blank"
                    class="cursor-pointer flex justify-between items-center py-2 px-4 text-gray-900 hover:bg-gray-100 group">

                    <div class="flex space-x-2 items-center">

                        <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 18v-5.25m0 0a6.01 6.01 0 0 0 1.5-.189m-1.5.189a6.01 6.01 0 0 1-1.5-.189m3.75 7.478a12.06 12.06 0 0 1-4.5 0m3.75 2.383a14.406 14.406 0 0 1-3 0M14.25 18v-.192c0-.983.658-1.823 1.508-2.316a7.5 7.5 0 1 0-7.517 0c.85.493 1.509 1.333 1.509 2.316V18" />
                        </svg>

                        <span class="text-xs text-gray-500 group-hover:text-gray-900">
                            Suggest another option
                        </span>

                    </div>

                    <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 4.5 21 12m0 0-7.5 7.5M21 12H3" />
                    </svg>

                </a>

            </template>

        </CustomDropdown>

        <!-- Send Using Whatsapp -->
        <CustomModal
            approveText="Send"
            approveType="success"
            approveIcon="whatsapp"
            ref="sendToWhatsappModal"
            header="Send To Whatsapp"
            :scrollOnContent="false"
            :approveAction="sendToWhatsapp">

            <template #content>

                <div class="flex items-center space-x-2 mb-4">

                    <CustomSelect
                        class="w-full"
                        v-model="whatsappAction"
                        :options="whatsappActions">
                    </CustomSelect>

                    <Pill :type="activeTab == 'edit' ? 'primary' : 'light'" size="sm" :action="selectEditTab">Edit</Pill>
                    <Pill :type="activeTab == 'preview' ? 'primary' : 'light'" size="sm" :action="selectPreviewTab">Preview</Pill>

                </div>

                <WhatsappMessage
                    class="mb-8"
                    v-if="activeTab == 'preview'"
                    :message="sendableWhatsappMessage">
                </WhatsappMessage>

                <div v-else class="space-y-4 mb-8">

                    <!-- Whatsapp Message Textarea -->
                    <CustomInput
                        rows="6"
                        type="textarea"
                        label="Message to send"
                        v-model="whatsappMessage"
                        placeholder="Your whatsapp message">
                    </CustomInput>

                    <template v-if="whatsappAction == 'Share order details'">

                        <div class="flex space-x-2 p-4 text-sm bg-green-100 rounded-lg">

                            <svg class="w-16 h-8" xmlns="http://www.w3.org/2000/svg"  viewBox="0 0 48 48" width="96px" height="96px" fill-rule="evenodd" clip-rule="evenodd">
                                <path fill="#fff" d="M4.868,43.303l2.694-9.835C5.9,30.59,5.026,27.324,5.027,23.979C5.032,13.514,13.548,5,24.014,5c5.079,0.002,9.845,1.979,13.43,5.566c3.584,3.588,5.558,8.356,5.556,13.428c-0.004,10.465-8.522,18.98-18.986,18.98c-0.001,0,0,0,0,0h-0.008c-3.177-0.001-6.3-0.798-9.073-2.311L4.868,43.303z"/>
                                <path fill="#fff" d="M4.868,43.803c-0.132,0-0.26-0.052-0.355-0.148c-0.125-0.127-0.174-0.312-0.127-0.483l2.639-9.636c-1.636-2.906-2.499-6.206-2.497-9.556C4.532,13.238,13.273,4.5,24.014,4.5c5.21,0.002,10.105,2.031,13.784,5.713c3.679,3.683,5.704,8.577,5.702,13.781c-0.004,10.741-8.746,19.48-19.486,19.48c-3.189-0.001-6.344-0.788-9.144-2.277l-9.875,2.589C4.953,43.798,4.911,43.803,4.868,43.803z"/>
                                <path fill="#cfd8dc" d="M24.014,5c5.079,0.002,9.845,1.979,13.43,5.566c3.584,3.588,5.558,8.356,5.556,13.428c-0.004,10.465-8.522,18.98-18.986,18.98h-0.008c-3.177-0.001-6.3-0.798-9.073-2.311L4.868,43.303l2.694-9.835C5.9,30.59,5.026,27.324,5.027,23.979C5.032,13.514,13.548,5,24.014,5 M24.014,42.974C24.014,42.974,24.014,42.974,24.014,42.974C24.014,42.974,24.014,42.974,24.014,42.974 M24.014,42.974C24.014,42.974,24.014,42.974,24.014,42.974C24.014,42.974,24.014,42.974,24.014,42.974 M24.014,4C24.014,4,24.014,4,24.014,4C12.998,4,4.032,12.962,4.027,23.979c-0.001,3.367,0.849,6.685,2.461,9.622l-2.585,9.439c-0.094,0.345,0.002,0.713,0.254,0.967c0.19,0.192,0.447,0.297,0.711,0.297c0.085,0,0.17-0.011,0.254-0.033l9.687-2.54c2.828,1.468,5.998,2.243,9.197,2.244c11.024,0,19.99-8.963,19.995-19.98c0.002-5.339-2.075-10.359-5.848-14.135C34.378,6.083,29.357,4.002,24.014,4L24.014,4z"/>
                                <path fill="#40c351" d="M35.176,12.832c-2.98-2.982-6.941-4.625-11.157-4.626c-8.704,0-15.783,7.076-15.787,15.774c-0.001,2.981,0.833,5.883,2.413,8.396l0.376,0.597l-1.595,5.821l5.973-1.566l0.577,0.342c2.422,1.438,5.2,2.198,8.032,2.199h0.006c8.698,0,15.777-7.077,15.78-15.776C39.795,19.778,38.156,15.814,35.176,12.832z"/>
                                <path fill="#fff" fill-rule="evenodd" d="M19.268,16.045c-0.355-0.79-0.729-0.806-1.068-0.82c-0.277-0.012-0.593-0.011-0.909-0.011c-0.316,0-0.83,0.119-1.265,0.594c-0.435,0.475-1.661,1.622-1.661,3.956c0,2.334,1.7,4.59,1.937,4.906c0.237,0.316,3.282,5.259,8.104,7.161c4.007,1.58,4.823,1.266,5.693,1.187c0.87-0.079,2.807-1.147,3.202-2.255c0.395-1.108,0.395-2.057,0.277-2.255c-0.119-0.198-0.435-0.316-0.909-0.554s-2.807-1.385-3.242-1.543c-0.435-0.158-0.751-0.237-1.068,0.238c-0.316,0.474-1.225,1.543-1.502,1.859c-0.277,0.317-0.554,0.357-1.028,0.119c-0.474-0.238-2.002-0.738-3.815-2.354c-1.41-1.257-2.362-2.81-2.639-3.285c-0.277-0.474-0.03-0.731,0.208-0.968c0.213-0.213,0.474-0.554,0.712-0.831c0.237-0.277,0.316-0.475,0.474-0.791c0.158-0.317,0.079-0.594-0.04-0.831C20.612,19.329,19.69,16.983,19.268,16.045z" clip-rule="evenodd"/>
                            </svg>

                            <span>Show, hide and move the order information to include with this whatsapp message</span>

                        </div>

                        <!-- Include Order field names -->
                        <CustomInput
                            type="checkbox"
                            v-model="includeOrderFieldNames"
                            inputLabel="Include Order field names">
                        </CustomInput>

                        <div class="border divide-y overflow-y-auto rounded-lg px-4 mb-4">

                            <!-- Draggable Whatsapp Fields -->
                            <draggable
                                class="divide-y mb-4"
                                v-model="whatsappFields"
                                handle=".draggable-handle"
                                ghost-class="bg-yellow-50">

                                <template
                                    :key="index"
                                    v-for="(whatsappField, index) in whatsappFields">

                                    <div class="flex items-center justify-between p-4">

                                        <!-- Active Toogle Switch -->
                                        <CustomSwitch
                                            size="xs"
                                            v-model="whatsappField.active"
                                            :suffixText="whatsappField.name"
                                        />

                                        <div class="flex items-center space-x-4">

                                            <!-- Gap Checkbox -->
                                            <CustomInput
                                                type="checkbox"
                                                inputLabel="Gap"
                                                v-if="whatsappField.active"
                                                v-model="whatsappField.linebreak">
                                            </CustomInput>

                                            <!-- Drag & Drop Handle -->
                                            <svg class="draggable-handle w-4 h-4 cursor-grab hover:text-yellow-500 visible:cursor-grabbing" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3.75v4.5m0-4.5h4.5m-4.5 0L9 9M3.75 20.25v-4.5m0 4.5h4.5m-4.5 0L9 15M20.25 3.75h-4.5m4.5 0v4.5m0-4.5L15 9m5.25 11.25h-4.5m4.5 0v-4.5m0 4.5L15 15" />
                                            </svg>

                                        </div>

                                    </div>

                                </template>

                            </draggable>

                        </div>

                    </template>

                </div>

            </template>

        </CustomModal>

    </div>

</template>

<script>

    import Pill from '@Partials/pills/Pill.vue';
    import { VueDraggableNext } from 'vue-draggable-next';
    import CustomInput from '@Partials/inputs/CustomInput.vue';
    import CustomModal from '@Partials/inputs/CustomModal.vue';
    import CustomSelect from '@Partials/inputs/CustomSelect.vue';
    import CustomSwitch from '@Partials/inputs/CustomSwitch.vue';
    import CustomDropdown from '@Partials/inputs/CustomDropdown.vue';
    import WhatsappMessage from '@Partials/whatsapp/WhatsappMessage.vue';

    export default {
        inject: ['orderState', 'storeState'],
        components: {
            Pill, draggable: VueDraggableNext, CustomInput, CustomModal,
            CustomSelect, CustomSwitch, CustomDropdown, WhatsappMessage
        },
        data() {
            return {
                activeTab: 'edit',
                whatsappAction: null,
                whatsappMessage: null,
                sendToWhatsappModal: null,
                includeOrderFieldNames: true,
                sendableWhatsappMessage: null,
                whatsappFields: this.prepareWhatsappFields(),
                whatsappActions: this.prepareWhatsappActions(),
            }
        },
        watch: {
            whatsappAction(newValue) {
                this.setWhatsappMessage(newValue);
                this.generateWhatsappMessage();
            },
            activeTab() {
                this.generateWhatsappMessage();
            },
        },
        computed: {
            order() {
                return this.orderState.order;
            },
            store() {
                return this.storeState.store;
            },
            isLoadingOrder() {
                return this.orderState.isLoadingOrder;
            },
            isLoadingStore() {
                return this.storeState.isLoadingStore;
            },
        },
        methods: {
            selectEditTab() {
                this.activeTab = 'edit';
            },
            selectPreviewTab() {
                this.activeTab = 'preview';
            },
            prepareWhatsappActions() {
                const actionNames = [
                    'Write message',
                    'Request review',
                    'Share order details',
                    'Remind about payment',
                    'Request proof of payment',
                    'Send payment confirmation',
                    'Send completion confirmation',
                    'Send cancellation confirmation',
                    'Send thank you message',
                ];

                return actionNames.map(name => ({
                    'label': name,
                    'value': name
                }));
            },
            prepareWhatsappFields() {
                const whatsappFieldNames = ['Number', 'Customer', 'Summary', 'Status', 'Payment Status', 'Collection Status', 'Grand Total', 'Paid', 'Pending', 'Outstanding', 'Customer Note', 'Created Date', 'Order Link'];
                const defaultWhatsappFieldNames  = ['Number', 'Customer', 'Summary', 'Status', 'Grand Total', 'Created Date', 'Order Link'];

                return whatsappFieldNames.map(name => ({
                    name,
                    linebreak: false,
                    active: defaultWhatsappFieldNames.includes(name),
                    priority: defaultWhatsappFieldNames.includes(name)
                }));
            },
            showSendToWhatsappModal(whatsappAction) {
                this.selectEditTab();
                this.$refs.dropdown.hideDropdown();
                this.whatsappAction = whatsappAction;
                this.sendToWhatsappModal.showModal();
            },
            setWhatsappMessage() {

                const messages = {
                    'Request review': `Hello ${this.order.customerFirstName}, we hope you enjoyed your order! Could you take a moment to leave us a review? Your feedback is greatly appreciated!`,

                    'Share order details': `Hello ${this.order.customerFirstName}, here are the details of your order:\n\nOrder #${this.order._attributes.number}\n`+`----------------------\n`,

                    'Remind about payment': `Hello ${this.order.customerFirstName}, just a friendly reminder that your order (#${this.order._attributes.number}) is currently unpaid. The total amount due is ${this.order.outstandingTotal.amountWithCurrency}. Kindly make payment at your earliest convenience. Let us know if you need assistance!`,

                    'Request proof of payment': `Hello ${this.order.customerFirstName}, could you please send us the proof of payment for order #${this.order._attributes.number}? This will help us process your order faster. Thank you!`,

                    'Send payment confirmation': `Hello ${this.order.customerFirstName}, we've received your payment for order #${this.order._attributes.number}. Your order is now being processed. Thank you for your prompt payment!`,

                    'Send completion confirmation': `Hello ${this.order.customerFirstName}, your order (#${this.order._attributes.number}) has been completed successfully! We hope you enjoy your meal. Thank you for ordering with us!`,

                    'Send cancellation confirmation': `Hello ${this.order.customerFirstName}, your order (#${this.order._attributes.number}) has been cancelled. If you have any questions or need further assistance, feel free to reach out to us.`,

                    'Send thank you message': `Hello ${this.order.customerFirstName}, thank you for your order! We truly appreciate your support and look forward to serving you again. Have a great day!`,

                    'Write message': `Write anything to ${this.order.customerFirstName}`
                };

                this.whatsappMessage = messages[this.whatsappAction] || null;

            },
            generateWhatsappMessage() {

                this.sendableWhatsappMessage = this.whatsappMessage;

                if(this.whatsappAction == 'Share order details') {

                    let orderMessage = '';

                    this.whatsappFields.forEach(field => {

                        if (field.active) {

                            if(field.linebreak) orderMessage += `\n`;
                            if(this.includeOrderFieldNames) orderMessage += `${field.name}: `;

                            switch (field.name) {
                                case "Number":
                                    orderMessage += `${this.order._attributes.number}\n`;
                                    break;
                                case "Customer":
                                    orderMessage += `${this.order._attributes.customerName}\n`;
                                    break;
                                case "Summary":
                                    orderMessage += `${this.order.summary}\n`;
                                    break;
                                case "Status":
                                    orderMessage += `${this.order.status.name}\n`;
                                    break;
                                case "Payment Status":
                                    orderMessage += `${this.order.paymentStatus.name}\n`;
                                    break;
                                case "Collection Status":
                                    orderMessage += `${this.order.collectionVerified.name}\n`;
                                    break;
                                case "Grand Total":
                                    orderMessage += `${this.order.grandTotal.amountWithCurrency}\n`;
                                    break;
                                case "Paid":
                                    orderMessage += `${this.order.paidTotal.amountWithCurrency}\n`;
                                    break;
                                case "Pending":
                                    orderMessage += `${this.order.pendingTotal.amountWithCurrency}\n`;
                                    break;
                                case "Outstanding":
                                    orderMessage += `${this.order.outstandingTotal.amountWithCurrency}\n`;
                                    break;
                                case "Customer Note":
                                    orderMessage += `${this.order.customerNote || 'None'}\n`;
                                    break;
                                case "Created Date":
                                    orderMessage += `${this.order.createdAt}\n`;
                                    break;
                                case "Order Link":
                                    orderMessage += `${window.location.origin + this.$router.resolve({
                                        name: 'show-store-order',
                                        params: {
                                            'store_href': this.store._links.showStore,
                                            'order_href': this.order._links.showOrder }
                                    }).href}\n`;
                                    break;
                            }

                        }

                    });

                    this.sendableWhatsappMessage += `\n\n${orderMessage.trim()}`;

                }
            },
            async sendToWhatsapp() {
                this.generateWhatsappMessage();
                window.open(`https://wa.me/?text=${encodeURIComponent(this.sendableWhatsappMessage)}`, "_blank");
                this.sendToWhatsappModal.hideModal();
            }
        },
        mounted() {
            this.sendToWhatsappModal = this.$refs.sendToWhatsappModal;
        },
    };

</script>
